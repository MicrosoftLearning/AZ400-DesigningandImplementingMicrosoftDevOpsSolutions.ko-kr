---
lab:
  title: '랩 08: 릴리스 게이트를 사용하여 배포 제어'
  module: 'Module 04: Design and implement a release strategy'
ms.openlocfilehash: 6d00ccd378210027178306df09af7945188074f3
ms.sourcegitcommit: f72fcf5ee578f465b3495f3cf789b06c530e88a4
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/04/2022
ms.locfileid: "139262582"
---
# <a name="lab-08-controlling-deployments-using-release-gates"></a>랩 08: 릴리스 게이트를 사용하여 배포 제어
# <a name="student-lab-manual"></a>학생용 랩 매뉴얼

## <a name="lab-overview"></a>랩 개요

이 랩에서는 배포 게이트의 구성을 살펴보고 배포 게이트를 사용하여 Azure Pipelines 실행을 제어하는 방법을 자세히 확인합니다. 그리고 배포 게이트 구현 방식을 파악하기 위해 Azure 웹앱용 환경 2개를 사용하여 릴리스 정의를 구성합니다. 또한 앱의 실행을 차단하는 버그가 없을 때만 cANARY 환경에 앱을 배포하고, Azure Monitor의 Application Insights에 활성 경고가 없을 때만 Canary 환경을 완료 상태로 표시합니다.

릴리스 파이프라인은 애플리케이션을 광범위한 환경에 배포할 수 있는 엔드투엔드 릴리스 프로세스를 지정합니다. 작업과 태스크를 사용하면 각 환경으로 애플리케이션을 배포하는 전체 과정을 자동화할 수 있습니다. 이상적으로는 애플리케이션에 대한 새 업데이트가 모든 사용자에게 동시에 노출되는 것을 원하지 않습니다. 즉, 업데이트는 단계별로 표시하는 것이 좋습니다. 가령 일부 사용자에게 업데이트를 먼저 표시하여 사용 방식을 모니터링한 다음 초기 사용자 세트에서 확인된 경험을 토대로 하여 다른 사용자에게 업데이트를 표시할 수 있습니다.

승인과 게이트를 사용하여 릴리스에서 배포의 시작 및 완료를 제어할 수 있습니다. 승인을 받으면 사용자가 배포를 수동으로 승인하거나 거부할 때까지 기다릴 수 있습니다. 릴리스 게이트를 사용하면, 릴리스가 다음 환경으로 승격되기 전에 충족해야 하는 애플리케이션 상태 조건을 지정할 수 있습니다. 환경 배포 전이나 이후에, 지정된 모든 게이트가 자동으로 평가됩니다. 이는 모두 통과하거나 정의된 시간 제한 기간에 도달하여 실패할 때까지 지속됩니다.

게이트는 배포 전 조건 또는 배포 후 조건 패널의 릴리스 정의에서 환경에 추가할 수 있습니다. 여러 게이트를 환경 조건에 추가하여 릴리스에 대한 모든 입력이 성공적으로 완료되도록 할 수 있습니다.

예를 들어

- 배포 전 게이트를 사용하면 빌드를 환경에 배포하기 전에 작업 항목이나 문제 관리 시스템에 활성 문제가 없는지를 확인할 수 있습니다.
- 배포 후 게이트를 사용하면 앱을 배포한 후 릴리스를 다음 환경으로 승격하기 전에 앱용 모니터링 또는 인시던트 관리 시스템에 인시던트가 발생하지 않음을 확인할 수 있습니다.

모든 계정에는 기본적으로 4가지 유형의 게이트가 포함되어 있습니다.

- Azure 함수 호출: Azure 함수 실행을 트리거하여 정상적으로 완료되는지 확인합니다. 
- Azure Monitor 경고 쿼리: 구성된 Azure Monitor 경고 규칙을 관찰하여 활성 경고를 확인합니다. 
- REST API 호출: REST API를 호출하고 응답이 정상 반환되면 작업을 계속 진행합니다. 
- 작업 항목 쿼리: 쿼리에서 반환된 일치하는 작업 항목 수가 임계값 범위 내인지를 확인합니다. 

## <a name="objectives"></a>목표

이 랩을 완료하면 다음 작업을 수행할 수 있습니다.

-   릴리스 파이프라인 구성
-   릴리스 게이트 구성
-   릴리스 게이트 테스트

## <a name="lab-duration"></a>랩 소요 시간

-   예상 소요 시간: **75분**

## <a name="instructions"></a>Instructions

### <a name="before-you-start"></a>시작하기 전에

#### <a name="sign-in-to-the-lab-virtual-machine"></a>랩 가상 머신에 로그인

다음 자격 증명을 사용하여 Windows 10 가상 머신에 로그인해야 합니다.
    
-   사용자 이름: **Student**
-   암호: **Pa55w.rd**

#### <a name="review-applications-required-for-this-lab"></a>이 랩에 필요한 애플리케이션 검토

이 랩에서 사용할 애플리케이션을 확인합니다.
    
-   Microsoft Edge

#### <a name="set-up-an-azure-devops-organization"></a>Azure DevOps 조직 설정 

이 랩에 사용할 수 있는 Azure DevOps 조직이 아직 없으면 [조직 또는 프로젝트 컬렉션 만들기](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/create-organization?view=azure-devops)에서 제공되는 지침에 따라 조직을 만듭니다.

#### <a name="prepare-an-azure-subscription"></a>Azure 구독 준비

-   기존 Azure 구독을 확인하거나 새 구독을 만듭니다.
-   Azure 구독의 Owner 역할, 그리고 Azure 구독과 연결된 Azure AD 테넌트의 전역 관리자 역할이 지정되어 있는 Microsoft 계정 또는 Azure AD 계정이 있는지 확인합니다. 자세한 내용은 [Azure Portal을 사용하여 Azure 역할 할당 목록 표시](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-list-portal) 및 [Azure Active Directory에서 관리자 역할 확인 및 할당](https://docs.microsoft.com/en-us/azure/active-directory/roles/manage-roles-portal#view-my-roles)을 참조하세요.

### <a name="exercise-0-configure-the-lab-prerequisites"></a>연습 0: 랩 필수 구성 요소 구성

이 연습에서는 랩의 필수 구성 요소를 설정합니다. 구체적으로는 Azure DevOps 데모 생성기 템플릿과 Azure 웹앱 2개를 기반으로 하여 미리 구성된 Parts Unlimited 팀 프로젝트를 설정합니다. Azure 웹앱 2개는 Azure Pipelines를 통해 애플리케이션을 배포할 **Canary** 및 **Production** 환경을 나타냅니다.

#### <a name="task-1-configure-the-team-project"></a>작업 1: 팀 프로젝트 구성

이 작업에서는 Azure DevOps 데모 생성기를 사용하여 **ReleaseGates** 템플릿을 기반으로 새 프로젝트를 생성합니다.

1.  랩 컴퓨터에서 웹 브라우저를 시작하고 [Azure DevOps 데모 생성기](https://azuredevopsdemogenerator.azurewebsites.net)로 이동합니다. 이 유틸리티 사이트에서는 계정 내에서 새 Azure DevOps 프로젝트를 만드는 프로세스를 자동으로 진행할 수 있습니다. 이 프로젝트에는 랩에 필요한 작업 항목, 리포지토리 등의 콘텐츠가 미리 입력되어 있습니다. 

    > **참고**: 사이트에 대한 자세한 내용은 https://docs.microsoft.com/en-us/azure/devops/demo-gen 을 참조하세요.

1.  **로그인** 을 클릭하고 Azure DevOps 구독과 연결된 Microsoft 계정을 사용하여 로그인합니다.
1.  필요한 경우 **Azure DevOps 데모 생성기** 페이지에서 **수락** 을 클릭하여 Azure DevOps 구독에 액세스하는 데 필요한 권한 요청을 수락합니다.
1.  **새 프로젝트 만들기** 페이지의 **새 프로젝트 이름** 텍스트 상자에 **릴리스 게이트를 사용하여 배포 제어** 를 입력합니다. 그런 다음 **조직 선택** 드롭다운 목록에서 Azure DevOps 조직을 선택하고 **템플릿 선택** 을 클릭합니다.
1.  템플릿 목록의 도구 모음에서 **DevOps 랩** 을 클릭하고 **ReleaseGates** 템플릿을 선택한 다음 **템플릿 선택** 을 클릭합니다.
1.  **새 프로젝트 만들기** 페이지로 돌아와서 **프로젝트 만들기** 를 클릭합니다.

    > **참고**: 프로세스가 완료될 때까지 기다립니다. 이 작업은 2분 정도 걸립니다. 프로세스가 실패하면 DevOps 조직으로 이동하여 프로젝트를 삭제한 후에 다시 시도합니다.

1.  **새 프로젝트 만들기** 페이지에서 **프로젝트로 이동** 을 클릭합니다.

#### <a name="task-2-create-two-azure-web-apps"></a>작업 2: Azure 웹앱 2개 만들기

이 작업에서는 Azure Pipelines를 통해 애플리케이션을 배포할 **Canary** 및 **Production** 환경을 나타내는 Azure 웹앱 2개를 만듭니다.

1.  랩 컴퓨터에서 웹 브라우저를 시작하여 [**Azure Portal**](https://portal.azure.com)로 이동한 다음, 이 랩에서 사용할 Azure 구독의 Owner 역할, 그리고 해당 구독과 연결된 Azure AD 테넌트의 전역 관리자 역할을 가진 사용자 계정으로 로그인합니다.
1.  Azure Portal의 페이지 위쪽 검색 텍스트 상자 바로 오른쪽에 있는 **Cloud Shell** 아이콘을 클릭합니다. 
1.  **Bash** 와 **PowerShell** 중 선택하라는 메시지가 표시되면 **Bash** 를 선택합니다. 

    >**참고**: **Cloud Shell** 을 처음 시작했는데 **탑재된 스토리지 없음** 이라는 메시지가 표시되면 이 랩에서 사용하는 구독을 선택하고 **스토리지 만들기** 를 선택합니다. 

1.  **Cloud Shell** 창의 **Bash** 프롬프트에서 다음 명령을 실행하여 리소스 그룹을 만듭니다. 여기서 `<region>` 자리 표시자는 Azure 웹앱 2개를 호스트할 Azure 지역의 이름(예: 'westeurope' 또는 'eastus')으로 바꿉니다.

    > **참고**: 가능한 위치는 다음 명령을 실행하여 찾을 수 있습니다. `<region>`에 대한 **이름**: `az account list-locations -o table` 사용

   
    ```bash
    RESOURCEGROUPNAME='az400m10l01-RG'
    az group create -n $RESOURCEGROUPNAME -l '<region>'
    ```

1.  App Service 계획을 만들려면 다음 명령을 실행합니다.
   
    ```bash
    SERVICEPLANNAME='az400m01l01-sp1'
    az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
    ```

    > **참고**: `ModuleNotFoundError: No module named 'vsts_cd_manager'`로 시작하는 오류 메시지와 함께 `az appservice plan create` 명령이 실패하는 경우 다음 명령을 실행한 다음, 실패한 명령을 다시 실행합니다.

    ```bash
    az extension remove -n appservice-kube
    az extension add --yes --source "https://aka.ms/appsvc/appservice_kube-latest-py2.py3-none-any.whl"
    ```

1.  고유한 앱 이름을 지정하여 웹앱 2개를 만듭니다.
 
     ```bash
     SUFFIX=$RANDOM$RANDOM
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Canary
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Prod
     ```

    > **참고**: Canary 웹앱의 이름을 기록합니다. 이 랩의 후반부에서 필요합니다.

1.  프로비전 프로세스가 완료될 때까지 기다린 후 **Cloud Shell** 창을 닫습니다. 

#### <a name="task-3-configure-an-application-insights-resource"></a>작업 3: Application Insights 리소스 구성

1.  Azure Portal에서 페이지 위쪽의 **검색 리소스, 서비스 및 문서** 텍스트 상자를 사용하여 **Application Insights** 를 검색한 다음 결과 목록에서 **Application Insights** 를 선택합니다.
1.  **Application Insights** 블레이드에서 **+ 만들기** 를 선택합니다. 
1.  **Application Insights** 블레이드의 **기본 사항** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 유지).

    | 설정 | 값 |
    | --- | --- |
    | Resource group | **az400m10l01-RG** |
    | Name | 이전 작업에서 기록한 Canary 웹앱의 이름 |
    | 지역 | 이전 작업에서 초반에서 웹앱을 배포한 것과 동일한 Azure 지역 |
    | 리소스 모드 | **클래식** |

    > **참고**: 사용 중단 관련 메시지는 무시하세요. 이 랩의 후반부에서 사용할 연속 통합 사용 DevOps 작업이 실패하지 않도록 하려면 이렇게 해야 합니다.

1.  **검토 + 만들기** 를 클릭한 다음, **만들기** 를 클릭합니다.
1.  프로비저닝 프로세스가 완료될 때까지 기다립니다.
1.  Azure Portal에서 이전 섹션에서 만든 **az400m10l01-RG** 리소스 그룹으로 이동합니다.
1.  리소스 목록에서 **Canary** 웹앱을 클릭합니다. 
1.  **Canary** 웹앱 페이지 왼쪽의 세로 메뉴에 있는 **설정** 섹션에서 **Application Insights** 를 클릭합니다.
1.  **Application Insights** 블레이드에서 **Application Insights 켜기** 를 클릭합니다.
1.  **리소스 변경** 섹션에서 **기존 리소스 선택** 옵션을 클릭하고 기존 리소스 목록에서 새로 만든 Application Insight 리소스를 선택한 다음 **적용** 을 클릭합니다. 그리고 작업을 확인하라는 메시지가 표시되면 **예** 를 클릭합니다.
1.  변경 사항이 적용될 때까지 기다린 다음 Application Insights 블레이드에서 **Application Insights 데이터 보기** 링크를 클릭합니다.

    > **참고**: 여기서는 이 랩 뒷부분에서 사용할 모니터 경고를 만듭니다. 

1.  Application Insights 리소스 블레이드의 **모니터링** 섹션에서 **경고** 를 클릭한 다음 **+ 새 경고 규칙** 을 클릭합니다.
1.  **경고 규칙 만들기** 블레이드의 **조건** 섹션에서 **조건 추가** 링크를 클릭합니다. 
1.  **신호 논리 구성** 블레이드의 **신호 이름으로 검색** 텍스트 상자에 **실패한 요청** 을 입력한 다음 실패한 요청을 선택합니다. 
1.  **신호 논리 구성** 블레이드의 **경고 논리** 섹션에서 **임계값** 을 **정적** 으로 설정한 상태로 두고 **임계값** 텍스트 상자에 **0** 을 입력한 후에 **완료** 를 클릭합니다.

    > **참고**: 지난 5분 동안 실패한 요청 수가 0보다 크면 규칙이 항상 경고를 생성합니다. 

1.  **경고 규칙 만들기** 창으로 돌아와 **경고 규칙 세부 정보** 에서 다음 설정을 지정하고 **경고 규칙 만들기** 를 클릭합니다. 다른 설정은 기본값으로 유지합니다.

    | 설정 | 값 |
    | --- | --- |
    | 경고 규칙 이름 | **PartsUnlimited_FailedRequests** |
    | 심각도 | **Sev 2** |
    | 자동으로 경고 해결 | 선택 취소 |

    > **참고**: 메트릭 경고 규칙을 활성화하려면 최대 10분이 걸릴 수 있습니다.

    > **참고**: 가용성 99% 미만, 서버 응답 시간 5초 초과, 서버 예외 0 초과 등의 다른 메트릭용으로 여러 경고 규칙을 만들 수 있습니다. 

### <a name="exercise-1-configure-release-pipeline"></a>연습 1: 릴리스 파이프라인 구성

이 연습에서는 릴리스 파이프라인을 구성합니다.

#### <a name="task-1-update-release-tasks"></a>작업 1: 릴리스 작업 업데이트

이 작업에서는 릴리스 작업을 업데이트합니다.

1.  랩 컴퓨터에서 Azure DevOps 포털의 **릴리스 게이트를 사용하여 배포 제어** 프로젝트가 표시된 브라우저 창으로 전환한 다음 세로 탐색 창에서 **Pipelines** 를 선택합니다. 그런 다음 **파이프라인** 섹션에서 **릴리스** 를 클릭합니다. 
1.  **릴리스** 보기 내의 **PartsUnlimited-CD** 창에서 **편집** 을 클릭합니다.

    > **참고**: 파이프라인에는 **Canary 환경** 과 **프로덕션** 의 2개 단계가 포함되어 있습니다. 

1.  **파이프라인** 탭의 **아티팩트** 사각형에서 **PartsUnlimited-CI** 빌드 아티팩트 오른쪽 위의 **연속 배포 트리거** 단추를 클릭합니다.
1.  **PartsUnlimited-CI** 빌드의 연속 배포 트리거가 사용하지 않도록 설정되어 있으면 스위치를 토글하여 트리거를 사용하도록 설정합니다. 다른 설정은 모두 기본값으로 유지하고 **연속 배포 트리거** 창 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다. 
1.  **Canary 환경** 단계 내에서 **작업 1개, 태스크 2개** 레이블을 클릭하고 이 페이지 내에서 해당 태스크를 검토합니다.

    > **참고**: canary 환경에는 작업 2개가 있습니다. 그 중 하나는 Azure 웹앱에 패키지를 게시하는 작업이고, 다른 하나는 배포 후 애플리케이션을 지속적으로 모니터링하도록 설정하는 작업입니다. 

1.  **모든 파이프라인 > PartsUnlimited-CD** 창에서 **Canary 환경** 단계가 선택되어 있는지 확인합니다. **Azure 구독** 드롭다운 목록에서 Azure 구독을 선택하고 **권한 부여** 를 클릭합니다. 메시지가 표시되면 Azure 구독의 Owner 역할이 지정된 사용자 계정을 사용하여 인증합니다.
1.  **App Service 이름** 드롭다운 목록에서 **Canary** 웹앱의 이름을 선택합니다.

    > **참고**: **새로 고침** 단추를 클릭해야 할 수 있습니다.

1.  **Application Insights의 리소스 그룹 이름** 드롭다운 목록에서 **az400m10l01-RG** 항목을 선택합니다.
1.  **Application Insights 리소스 이름** 드롭다운 목록에서 **Canary** Application Insights 리소스의 이름을 선택합니다. 이 이름은 **Canary** 웹앱 이름과 일치해야 합니다. 
1.  **모든 파이프라인 > PartsUnlimited-CD** 창에서 **작업** 탭을 클릭하고 드롭다운 목록에서 **프로덕션** 을 선택합니다.
1.  **프로덕션** 단계가 선택된 상태로 **Azure 구독** 드롭다운 목록에서 **Canary 환경** 단계에 대해 사용한 Azure 구독을 선택합니다(**사용 가능한 Azure 서비스 연결** 아래에 표시됨). 구독을 사용하도록 권한을 부여할 때 이미 서비스 연결을 만들었기 때문입니다.
1. **App Service 이름** 드롭다운 목록에서 **프로덕션** 웹앱의 이름을 선택합니다.
1. **모든 파이프라인 > PartsUnlimited-CD** 창에서 **저장** 을 클릭하고 **저장** 대화 상자에서 **확인** 을 클릭합니다
1. **릴리스 게이트를 사용하여 배포 제어** 프로젝트가 표시된 브라우저 창의 세로 탐색 창에 있는 **파이프라인** 섹션에서 **파이프라인** 을 클릭합니다. 
1. **파이프라인** 창에서 **PartsUnlimited-CI** 빌드 파이프라인을 나타내는 항목을 클릭하고 **PartsUnlimited-CI** 창에서 **파이프라인 실행** 을 클릭합니다. 
1. **파이프라인 실행** 페이지에서 기본 설정을 수락하고 **실행** 을 클릭하여 파이프라인을 트리거합니다. **빌드 파이프라인이 완료될 때까지 기다립니다**.

    > **참고**: 빌드가 정상적으로 완료되면 릴리스가 자동으로 트리거되며 애플리케이션이 두 환경에 배포됩니다.

1. 세로 탐색 창의 **파이프라인** 섹션에서 **릴리스** 를 클릭하고 **PartsUnlimited-CD** 창에서 최신 릴리스를 나타내는 항목을 클릭합니다.
1. **PartsUnlimited-CD > Release-1** 블레이드에서 릴리스 진행률을 추적하여 두 웹앱으로의 배포가 정상적으로 완료되었는지 확인합니다.
1. Azure Portal 인터페이스로 전환하여 **az400m10l01-RG** 리소스 그룹으로 이동한 다음 리소스 목록에서 **Canary** 웹앱을 클릭합니다. 그런 후에 웹앱 블레이드에서 **찾아보기** 를 클릭하여 새 웹 브라우저 탭에서 웹 페이지가 정상적으로 로드되는지 확인합니다.
1. **Parts Unlimited** 웹 사이트가 표시된 웹 브라우저 탭을 닫습니다.
1. Azure Portal 인터페이스로 전환하여 **az400m10l01-RG** 리소스 그룹으로 다시 이동한 다음 리소스 목록에서 **프로덕션** 웹앱을 클릭합니다. 그런 후에 웹앱 블레이드에서 **찾아보기** 를 클릭하여 새 웹 브라우저 탭에서 웹 페이지가 정상적으로 로드되는지 확인합니다.
1. **Parts Unlimited** 웹 사이트가 표시된 웹 브라우저 탭을 닫습니다.

    > **참고**: 이제 애플리케이션에서 CI/CD가 구성되었습니다. 다음 연습에서는 릴리스 파이프라인에서 게이트를 설정합니다.

### <a name="exercise-2-configure-release-gates"></a>연습 2: 릴리스 게이트 구성

이 연습에서는 릴리스 파이프라인에서 게이트를 설정합니다.

#### <a name="task-1-configure-pre-deployment-gates"></a>작업 1: 배포 전 게이트 구성

이 작업에서는 배포 전 게이트를 구성합니다.

1.  Azure DevOps 포털이 표시된 웹 브라우저 창으로 전환하여 세로 탐색 창에 있는 **파이프라인** 섹션에서 **릴리스** 를 클릭하고 **PartsUnlimited-CD** 창에서 **편집** 을 클릭합니다.
1.  **모든 파이프라인 > PartsUnlimited-CD** 창에서 **Canary 환경** 단계를 나타내는 사각형의 왼쪽 모서리에 있는 **배포 전 조건** 을 나타내는 타원을 클릭합니다.
1.  **배포 전 조건** 창에서 **배포 전 승인** 슬라이더를 **사용으로 설정** 하고 **승인자** 텍스트 상자에 Azure DevOps 계정 이름을 입력한 다음 선택합니다. 
1.  **배포 전 조건** 창에서 **게이트** 슬라이더를 **사용으로 설정** 하고 **+ 추가** 를 클릭한 다음 팝업 메뉴에서 **쿼리 작업 항목** 을 클릭합니다.
1.  **배포 전 조건** 창의 **쿼리 작업 항목** 섹션에 있는 **쿼리** 드롭다운 목록에서 **공유 쿼리** 아래의 **버그** 를 선택하고 **상한 임계값** 의 값은 **0** 으로 설정된 상태로 유지합니다.

    > **참고**: **상한 임계값** 의 값에 따라 이 쿼리가 활성 버그 작업 항목을 반환하면 릴리스 게이트는 실패합니다.

1.  **배포 전 조건** 창에서 **평가 전 지연** 설정의 값을 **5분** 으로 설정된 상태로 유지합니다. 

    > **참고**: **평가 전 지연** 은 추가한 게이트를 처음 평가할 때까지의 시간을 나타냅니다. 게이트를 추가하지 않으면 지정한 기간 동안 기다린 후에 배포가 진행됩니다. 게이트 기능이 정확한 결과 반환을 시작할 때까지는 시간이 다소 걸릴 수 있으므로, 여기서는 게이트 기능이 초기화 및 안정화될 수 있도록 지연을 구성합니다. 그러면 이 지연 시간이 지난 후에 결과를 평가하여 배포를 승인할지 아니면 거부할지를 결정하는 데 해당 결과를 사용합니다.

1.  **배포 전 조건** 창에서 **평가 옵션** 섹션을 확장하고 다음 옵션을 구성합니다.

    - **게이트 재평가 간격** 값을 **5분** 으로 설정합니다.

    > **참고**: **게이트 재평가 간격** 은 모든 게이트의 평가 간 시간 간격을 나타냅니다. 샘플링 간격마다 각 게이트에 신규 요청을 동시에 전송하여 새 결과를 수신합니다. 모든 응답을 수신하기에 충분한 시간을 설정하려면 샘플링 간격이 구성되어 있는 모든 게이트의 일반적인 최장 응답 시간보다 커야 합니다.

    - **이 시간 후에 게이트가 실패하는 시간 제한** 값을 **8분** 으로 설정합니다.

    > **참고**: **이 시간 후에 게이트가 실패하는 시간 제한** 은 모든 게이트의 최대 평가 기간을 나타냅니다. 동일 샘플링 간격 동안 모든 게이트의 평가가 정상적으로 완료되기 전에 시간 제한에 도달하면 배포는 거부됩니다. 지정 가능한 시간 제한 최소값은 6분, 샘플링 간격 최소값은 5분입니다.

    > **참고**: 이 경우 릴리스가 트리거되면 게이트는 *0 <sup>분</sup>* 및 *5<sup></sup>* 분에 샘플의 유효성을 검사합니다. 결과가 **통과** 이면 승인을 위한 알림이 전송됩니다. 결과가 **실패** 이면 *8<sup></sup>* 분째에 릴리스의 시간이 초과됩니다.

    > **참고**: 실제 상황에서 이러한 값은 몇 시간이 될 수도 있습니다. 

1.  **배포 전 조건** 창에서 **게이트 성공 시 승인 요청** 라디오 단추를 선택합니다.
1.  **배포 전 조건** 창 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다. 릴리스 파이프라인에 변경 내용을 **저장** 합니다.
1.  **쿼리 작업 항목** 게이트가 작동하려면 **프로젝트 빌드 서비스** 에 Azure Boards 쿼리에 대한 읽기 권한이 필요합니다.
1.  Azure DevOps 포털의 세로 탐색 창에서 **Boards** 위에 마우스 포인터를 놓고 **Ctrl** 키를 누른 상태로 **쿼리** 를 클릭하면 새 브라우저 탭이 열리고 **쿼리** 창이 표시됩니다.
1.  **Boards** 보기의 **쿼리** 창에서 **모두** 를 클릭하여 모든 쿼리의 목록을 가져옵니다.
1.  **공유 쿼리** 폴더를 마우스 오른쪽 단추로 클릭하고 **보안...** 을 선택하여 **공유 쿼리에 대한 사용 권한** 창을 엽니다.
1.  **공유 쿼리에 대한 사용 권한** 창의 **사용자 또는 그룹 검색** 필드에 **릴리스 게이트 빌드 서비스를 사용하여 배포 제어**([프로젝트 이름] 빌드 서비스)를 입력하거나 붙여넣고 확인된 ID를 클릭합니다.

    > **참고**: **릴리스 게이트 빌드 서비스를 사용하여 배포 제어** 사용자는 **사용자** 목록의 구성원으로 표시되어 있지 않으므로 위에서 설명한 방법으로 검색해야 합니다. **프로젝트 컬렉션 빌드 서비스** 사용자와 **프로젝트 빌드 서비스** 를 혼동하지 마세요.

1.  **사용자** 목록에서 **릴리스 게이트 빌드 서비스를 사용하여 배포 제어** 사용자를 선택하고 오른쪽에서 **읽기** 권한을 **허용** 으로 설정합니다.
1.  **공유 쿼리에 대한 사용 권한** 창 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다.
1.  릴리스 파이프라인이 아직 열려 있는 브라우저 탭으로 다시 이동합니다.
   
#### <a name="task-2-configure-post-deployment-gates"></a>작업 2: 배포 후 게이트 구성

이 작업에서는 Canary 환경의 배포 후 게이트를 사용하도록 설정합니다.

1.  **모든 파이프라인 > PartsUnlimited-CD** 창으로 돌아와 **Canary 환경** 단계를 나타내는 사각형의 오른쪽 모서리에 있는 **배포 후 조건** 을 나타내는 타원을 클릭합니다.
1.  **배포 후 조건** 창에서 **게이트** 슬라이더를 **사용으로 설정** 하고 **+ 추가** 를 클릭한 다음 팝업 메뉴에서 **Azure Monitor 경고 쿼리** 를 클릭합니다.
1.  **배포 후 조건** 창의 **Azure Monitor 경고 쿼리** 섹션에 있는 **Azure 구독** 드롭다운 목록에서 Azure 구독에 연결을 나타내는 항목을 선택하고 **리소스 그룹** 드롭다운 목록에서 **az400m10l01-RG** 항목을 선택합니다.
1.  **배포 후 조건** 창에서 **평가 옵션** 을 확장하고 다음 옵션을 구성합니다.

- **게이트 재평가 간격** 값을 **5분** 으로 설정합니다.
- **이 시간 후에 게이트가 실패하는 시간 제한** 값을 **8분** 으로 설정합니다.
- **게이트 성공 시 승인 요청** 옵션을 선택합니다.

    > **참고**: 샘플링 간격과 시간 제한은 연동되므로 게이트는 적절한 간격으로 함수를 호출하며, 시간 제한에 해당하는 기간 내의 동일 샘플링 간격 동안 배포가 정상적으로 완료되지 않으면 배포를 거부합니다. 

1.  **배포 후 조건 창** 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다.
1.  **PartsUnlimited-CD** 창으로 돌아와 **저장** 을 클릭하고 **저장** 대화 상자에서 **확인** 을 클릭합니다.


### <a name="exercise-3-test-release-gates"></a>연습 3: 릴리스 게이트 테스트

이 연습에서는 애플리케이션을 업데이트하여 릴리스 게이트를 테스트합니다. 애플리케이션을 업데이트하면 배포가 트리거됩니다.

#### <a name="task-1-update-and-deploy-application-after-adding-release-gates"></a>작업 1: 릴리스 게이트 추가 후 애플리케이션 업데이트 및 배포

이 작업에서는 릴리스 게이트를 사용하여 릴리스 프로세스를 추적합니다.

1.  Azure DevOps 포털이 표시된 브라우저 창의 세로 탐색 창에서 **릴리스** 를 선택합니다. 
1.  **릴리스 만들기** 를 클릭한 다음 **새 릴리스 만들기** 창에서 **만들기** 를 클릭합니다.
1.  Azure DevOps 포털 왼쪽의 세로 탐색 창에 있는 **파이프라인** 섹션에서 **릴리스** 를 클릭합니다. 
1.  **릴리스** 탭에서 **PartsUnlimited-CD/Release-2** 항목을 클릭하여 **Canary 환경** 으로의 배포 진행률을 검토합니다. 
1.  **Canary 환경** 단계를 나타내는 사각형의 왼쪽 모서리에 있는 **배포 전 조건** 을 나타내는 타원을 클릭합니다. 이 시점에서 배포 전 조건의 레이블은 **게이트 평가** 중 또는 **배포 전 게이트 실패** 로 표시될 수 있습니다.
1.  **Canary 환경** 창에서 **쿼리 작업 항목** 게이트가 실패했음을 확인합니다.

    > **참고**: 이 실패는 활성 작업 항목이 있음을 나타냅니다. 이러한 작업 항목을 닫아야 배포를 계속 진행할 수 있습니다. 다음 샘플링 시간은 5분 후입니다.

1.  새 브라우저 탭을 열고 Azure DevOps 포털로 이동한 다음 세로 탐색 창에 있는 **Boards** 를 선택하고 **Boards** 섹션에서 **쿼리** 를 선택합니다.
1.  **Boards** 보기의 **쿼리** 창에서 **모두** 탭을 클릭합니다.
1.  **쿼리** 창의 **모두** 탭 **공유 쿼리** 섹션에서 **버그** 항목을 클릭하고 **쿼리 > 공유 쿼리 > 버그** 창에서 **쿼리 실행** 을 클릭합니다. 
1.  쿼리가 **신규** 상태의 작업 항목 **Canary 환경에 디스크 공간이 부족합니다.** 를 반환함을 확인합니다.

    > **참고**: 여기서는 인프라 팀이 디스크 공간 문제를 해결했다고 가정하겠습니다. 

1.  **Canary 환경에 디스크 공간이 부족합니다.** 항목을 클릭합니다.
1.  **Canary 환경에 디스크 공간이 부족합니다.** 창 왼쪽 위의 **상태** 레이블 옆에 있는 **신규** 를 클릭하고 드롭다운 목록에서 **닫힘** 을 클릭한 후에 **저장** 을 클릭합니다.
1.  **Canary 환경** 창으로 다시 전환한 다음 두 번째 평가에 통과할 때까지 기다립니다. 

    > **참고**: 두 번째 평가가 이미 실패한 경우 **Canary 환경** 단계를 나타내는 사각형 위에 마우스 포인터를 놓으면 **다시 배포** 옵션이 표시됩니다. **다시 배포** 를 클릭하고 **Canary 환경** 블레이드에서 **배포** 를 클릭한 후에 배포 전 게이트 처리 상태를 모니터링합니다. 

    > **참고**: 평가가 정상적으로 완료되면 배포 전 승인 요청이 표시됩니다. 

1.  **승인자** 를 클릭한 다음 **승인** 을 클릭하여 배포를 Canary 환경 큐에 대기시킵니다.

    > **참고**: Canary 환경으로의 배포가 정상적으로 완료되면 배포 후 게이트가 작동합니다. 이 게이트는 Application Insights를 사용하여 새로 배포한 애플리케이션을 대상으로 하는 실패한 요청 유무를 검색합니다. 

1.  실패한 요청을 트리거하려면 Azure Portal이 표시된 웹 브라우저 창으로 전환하여 **Canary** Azure 웹앱 블레이드로 이동한 다음 **찾아보기** 를 클릭합니다. 그러면 새 브라우저 탭이 열리고 PartsUnlimited 웹 사이트가 표시됩니다. 
1.  PartsUnlimited 웹 사이트에서 **자세히** 를 클릭합니다.

    > **참고**: 웹 사이트의 이 부분은 의도적으로 잘못 구성되어 있으므로 실패한 요청이 트리거됩니다. 

1.  PartsUnlimited 웹 사이트 홈 페이지로 돌아와서 **자세히** 를 다시 클릭하여 이 단계를 몇 번 더 반복합니다.
1.  Application Insights에서 실패한 요청을 검색했는지 확인합니다. 이렇게 하려면 **Canary** 웹앱 페이지의 Application Insights 블레이드로 이동하여 Application Insights 블레이드에서 **경고** 를 클릭한 다음 페이지에 **심각도 2** 경고가 하나 이상 나열되는지 확인합니다. 

    > **참고**: 예외로 인해 트리거된 경고가 있으므로 **Azure Monitor 쿼리** 게이트는 실패합니다. 그러므로 **프로덕션** 환경으로의 배포도 중단됩니다.

### <a name="exercise-4-remove-the-azure-lab-resources"></a>연습 4: Azure 랩 리소스 제거

이 연습에서는 예상치 못한 비용이 발생하지 않도록 이 랩에서 프로비전한 Azure 리소스를 제거합니다. 

>**참고**: 더 이상 사용하지 않는 새로 만든 Azure 리소스는 모두 제거하세요. 사용되지 않는 리소스를 제거하면 예기치 않은 요금이 발생하지 않습니다.

#### <a name="task-1-remove-the-azure-lab-resources"></a>작업 1: Azure 랩 리소스 제거

이 작업에서는 Azure Cloud Shell을 사용하여 불필요한 비용이 발생하지 않도록 이 랩에서 프로비전한 Azure 리소스를 제거합니다. 

1.  Azure Portal의 **Cloud Shell** 창에서 **Bash** 세션을 시작합니다.
1.  다음 명령을 실행하여 이 모듈의 전체 랩에서 생성된 모든 리소스 그룹을 나열합니다.

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].name" --output tsv
    ```

1.  다음 명령을 실행하여 이 모듈의 랩 전체에서 만든 모든 리소스 그룹을 삭제합니다.

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    >**참고**: 명령은 비동기적으로 실행되므로(--nowait 매개 변수에 의해 결정됨) 동일한 Bash 세션 내에서 즉시 다른 Azure CLI 명령을 실행할 수 있지만 리소스 그룹이 실제로 제거되기까지 몇 분 정도 걸립니다.

## <a name="review"></a>검토

이 랩에서는 릴리스 파이프라인을 구성한 다음 릴리스 게이트를 구성하고 테스트했습니다. 
